name: Update Elastic Agent Config

on:
  pull_request:
    branches: [main]
    paths:
      - 'monitors/**/*.json'
  workflow_run:
    workflows: ["Import Synthetics Monitors"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  update-elastic-agent:
    runs-on: ubuntu-latest
    # Run only on successful import workflows or PR events
    if: github.event_name != 'workflow_run' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    steps:
    - name: Check if update should proceed
      if: github.event_name == 'workflow_run'
      id: should-update
      run: |
        echo "Workflow run event details:"
        echo "Event name: ${{ github.event_name }}"
        echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
        echo "Workflow run event: ${{ github.event.workflow_run.event }}"
        echo "Workflow run name: ${{ github.event.workflow_run.name }}"
        echo "Head commit message: ${{ github.event.workflow_run.head_commit.message }}"
        
        # Only proceed for push events (auto imports) or live manual imports
        if [ "${{ github.event.workflow_run.event }}" = "push" ]; then
          echo "Push event detected - proceeding with elastic agent update"
          echo "should_update=true" >> $GITHUB_OUTPUT
        elif [ "${{ github.event.workflow_run.event }}" = "workflow_dispatch" ]; then
          # For manual runs, we can't easily detect if it was dry run or fresh import
          # So we'll proceed and let the change detection handle it
          echo "Manual workflow dispatch detected - proceeding with elastic agent update"
          echo "should_update=true" >> $GITHUB_OUTPUT
        else
          echo "Skipping elastic agent update for event type: ${{ github.event.workflow_run.event }}"
          echo "should_update=false" >> $GITHUB_OUTPUT
        fi

    - name: Checkout repository
      if: github.event_name != 'workflow_run' || steps.should-update.outputs.should_update == 'true'
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        ref: ${{ github.head_ref }}
    
    - name: Setup Python
      if: github.event_name != 'workflow_run' || steps.should-update.outputs.should_update == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Python dependencies
      if: github.event_name != 'workflow_run' || steps.should-update.outputs.should_update == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Get changed monitor folders
      if: github.event_name != 'workflow_run' || steps.should-update.outputs.should_update == 'true'
      id: changed-folders
      run: |
        echo "Getting changed monitor JSON files..."
        echo "Event name: ${{ github.event_name }}"
        
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # For PR events, get changed files from PR
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E '^monitors/.*\.json$')
          echo "PR changed JSON files: $changed_files"
        elif [ "${{ github.event_name }}" = "workflow_run" ]; then
          # For workflow_run events, get changed files from the triggering push
          echo "Workflow run head SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Workflow run event: ${{ github.event.workflow_run.event }}"
          # Get files changed in the last commit that triggered the import workflow
          changed_files=$(git diff --name-only HEAD~1..HEAD | grep -E '^monitors/.*\.json$' || true)
          echo "Workflow run changed JSON files: $changed_files"
        else
          echo "Unsupported event type"
          changed_files=""
        fi
        
        if [ -n "$changed_files" ]; then
          # Extract unique folder names
          changed_folders=""
          for file in $changed_files; do
            folder=$(echo $file | cut -d'/' -f2)
            if [[ ! $changed_folders =~ $folder ]]; then
              changed_folders="$changed_folders $folder"
            fi
          done
          
          changed_folders=$(echo $changed_folders | xargs)
          echo "changed_folders=$changed_folders" >> $GITHUB_OUTPUT
          echo "Found changed folders: $changed_folders"
        else
          echo "changed_folders=" >> $GITHUB_OUTPUT
          echo "No changed monitor folders found"
        fi
    
    - name: Update Elastic Agent Configurations
      id: update-script
      if: (github.event_name != 'workflow_run' || steps.should-update.outputs.should_update == 'true') && steps.changed-folders.outputs.changed_folders != ''
      env:
        KIBANA_URL: ${{ secrets.KIBANA_URL }}
        KIBANA_API_KEY: ${{ secrets.KIBANA_API_KEY }}
      run: |
        echo "Updating elastic-agent.yml for folders: ${{ steps.changed-folders.outputs.changed_folders }}"
        output=$(python .github/scripts/update-elastic-agent.py ${{ steps.changed-folders.outputs.changed_folders }} 2>&1)
        echo "$output"
        echo "script_output<<EOF" >> $GITHUB_OUTPUT
        echo "$output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      continue-on-error: true
    
    - name: Commit and push changes
      if: steps.update-script.outcome == 'success'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add monitors/*/elastic-agent.yml
        git commit -m "Update elastic-agent.yml configurations - $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
        git push
    
    - name: Post success PR comment
      if: steps.update-script.outcome == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
          const changedFolders = '${{ steps.changed-folders.outputs.changed_folders }}';
          
          let locationDetails = '';
          if (changedFolders) {
            const folders = changedFolders.split(' ');
            for (const folder of folders) {
              locationDetails += `\n** ${folder}**\n- File: \`monitors/${folder}/elastic-agent.yml\`\n`;
            }
          }
          
          const output = `## üîÑ Elastic Agent Configuration Update Results
          *Updated at: ${timestamp}*
          
          ### ‚úÖ Successfully Updated Locations
          ${locationDetails}
          
          **Script Output:**
          \`\`\`
          ${{ steps.update-script.outputs.script_output }}
          \`\`\`
          
          ---
          **Summary:** Updated elastic-agent.yml configurations for ${changedFolders.split(' ').length} location(s)`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

    - name: Post failure PR comment
      if: steps.update-script.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
          const output = `## üîÑ Elastic Agent Configuration Update Results
          *Updated at: ${timestamp}*
          
          ### ‚ùå Update Failed
          
          There was an error updating the elastic-agent.yml files.
          
          **Error Details:**
          \`\`\`
          ${{ steps.update-script.outputs.script_output }}
          \`\`\`
          
          **Changed folders:** ${{ steps.changed-folders.outputs.changed_folders }}`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });